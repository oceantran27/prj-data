DP, range tree. O(n log k).

